// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MODEL - Shop Owner/Admin Authentication
// ============================================
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  password_hash String
  name          String
  role          UserRole @default(ADMIN)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("users")
}

enum UserRole {
  ADMIN
  STAFF
}

// ============================================
// CUSTOMER MODEL - Buyers (Guest + Regular)
// ============================================
model Customer {
  id        Int       @id @default(autoincrement())
  name      String
  mobile    String?   @db.VarChar(15)
  email     String?
  address   String?   @db.Text
  gstNumber String?   @map("gst_number") @db.VarChar(15)
  isGuest   Boolean   @default(false) @map("is_guest")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  
  invoices  Invoice[]

  @@index([mobile])
  @@index([isGuest])
  @@map("customers")
}

// ============================================
// PRODUCT MODEL - Inventory Items
// ============================================
model Product {
  id               Int      @id @default(autoincrement())
  name             String
  sku              String   @unique @db.VarChar(50)
  description      String?  @db.Text
  price            Decimal  @db.Decimal(10, 2)
  stockQuantity    Int      @default(0) @map("stock_quantity")
  minStockAlert    Int      @default(5) @map("min_stock_alert")
  category         String?  @db.VarChar(100)
  unit             String   @default("PCS") @db.VarChar(20) // PCS, KG, LITER, etc.
  isActive         Boolean  @default(true) @map("is_active")
  taxRate          Decimal  @default(18.0) @db.Decimal(5, 2) @map("tax_rate") // GST % (e.g., 18%)
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  invoiceItems     InvoiceItem[]
  inventoryLogs    InventoryLog[]

  @@index([sku])
  @@index([isActive])
  @@index([stockQuantity])
  @@map("products")
}

// ============================================
// INVOICE MODEL - Sales Records
// ============================================
model Invoice {
  id              Int            @id @default(autoincrement())
  invoiceNumber   String         @unique @map("invoice_number") @db.VarChar(50)
  customerId      Int            @map("customer_id")
  subtotal        Decimal        @db.Decimal(12, 2)
  taxAmount       Decimal        @default(0) @db.Decimal(10, 2) @map("tax_amount")
  discount        Decimal        @default(0) @db.Decimal(10, 2)
  totalAmount     Decimal        @db.Decimal(12, 2) @map("total_amount")
  paymentMode     PaymentMode    @map("payment_mode")
  paymentStatus   PaymentStatus  @default(PAID) @map("payment_status")
  notes           String?        @db.Text
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  customer        Customer       @relation(fields: [customerId], references: [id])
  items           InvoiceItem[]

  @@index([invoiceNumber])
  @@index([customerId])
  @@index([createdAt])
  @@index([paymentMode])
  @@map("invoices")
}

enum PaymentMode {
  CASH
  UPI
  CARD
  CREDIT
  NETBANKING
}

enum PaymentStatus {
  PAID
  PENDING
  PARTIAL
}

// ============================================
// INVOICE ITEM MODEL - Line Items in Invoice
// ============================================
model InvoiceItem {
  id          Int      @id @default(autoincrement())
  invoiceId   Int      @map("invoice_id")
  productId   Int      @map("product_id")
  productName String   @map("product_name") @db.VarChar(255) // Snapshot for historical data
  quantity    Int
  unitPrice   Decimal  @db.Decimal(10, 2) @map("unit_price")
  taxRate     Decimal  @db.Decimal(5, 2) @map("tax_rate") // Snapshot at time of sale
  taxAmount   Decimal  @db.Decimal(10, 2) @map("tax_amount")
  lineTotal   Decimal  @db.Decimal(12, 2) @map("line_total")
  createdAt   DateTime @default(now()) @map("created_at")

  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product     Product  @relation(fields: [productId], references: [id])

  @@index([invoiceId])
  @@index([productId])
  @@map("invoice_items")
}

// ============================================
// INVENTORY LOG - Audit Trail for Stock Changes
// ============================================
model InventoryLog {
  id             Int              @id @default(autoincrement())
  productId      Int              @map("product_id")
  transactionType TransactionType @map("transaction_type")
  quantityChange Int              @map("quantity_change") // Positive for RESTOCK, Negative for SALE
  previousStock  Int              @map("previous_stock")
  newStock       Int              @map("new_stock")
  referenceId    Int?             @map("reference_id") // InvoiceId for SALE, PO for RESTOCK
  notes          String?          @db.Text
  createdAt      DateTime         @default(now()) @map("created_at")

  product        Product          @relation(fields: [productId], references: [id])

  @@index([productId])
  @@index([transactionType])
  @@index([createdAt])
  @@map("inventory_logs")
}

enum TransactionType {
  SALE
  RESTOCK
  ADJUSTMENT
  RETURN
}
