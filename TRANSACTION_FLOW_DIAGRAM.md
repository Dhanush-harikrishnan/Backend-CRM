# ğŸ”„ Invoice Transaction Flow Diagram

## Visual Representation of Transaction Logic

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     CLIENT REQUEST                                  â”‚
â”‚  POST /api/invoices                                                â”‚
â”‚  {                                                                  â”‚
â”‚    "customerId": 1,                                                â”‚
â”‚    "items": [{"productId": 1, "quantity": 2}],                    â”‚
â”‚    "paymentMode": "CASH"                                          â”‚
â”‚  }                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MIDDLEWARE CHAIN                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. Helmet            â†’ Security Headers                            â”‚
â”‚  2. CORS              â†’ Origin Check                                â”‚
â”‚  3. Rate Limiter      â†’ Request Count Check                         â”‚
â”‚  4. Body Parser       â†’ Parse JSON                                  â”‚
â”‚  5. authenticate()    â†’ Verify JWT Token                            â”‚
â”‚  6. validate()        â†’ Zod Schema Validation                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   CONTROLLER LAYER                                  â”‚
â”‚  invoice.controller.ts                                              â”‚
â”‚  - Extract data from req.body                                       â”‚
â”‚  - Call service method                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SERVICE LAYER (TRANSACTION STARTS)               â”‚
â”‚  invoice.service.ts                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
        â•‘    prisma.$transaction(async (tx) => { ... })    â•‘
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                                 â”‚
        â–¼                                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  STEP 1: FETCH PRODUCTS              â”‚                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚                 â”‚
â”‚  const products = await tx.product   â”‚                 â”‚
â”‚    .findMany({                       â”‚                 â”‚
â”‚      where: { id: { in: [1, 2] } }  â”‚                 â”‚
â”‚    });                               â”‚                 â”‚
â”‚                                      â”‚                 â”‚
â”‚  Result:                             â”‚                 â”‚
â”‚  - Product 1: Rice (Stock: 100)     â”‚                 â”‚
â”‚  - Product 2: Salt (Stock: 200)     â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
                   â”‚                                     â”‚
                   â–¼                                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  STEP 2: VALIDATE STOCK âš ï¸ CRITICAL  â”‚                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚                 â”‚
â”‚  for (const item of items) {         â”‚                 â”‚
â”‚    if (stock < quantity) {           â”‚                 â”‚
â”‚      throw AppError(...)             â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚    }                                 â”‚          â”‚      â”‚
â”‚  }                                   â”‚          â”‚      â”‚
â”‚                                      â”‚          â”‚      â”‚
â”‚  Check:                              â”‚          â”‚      â”‚
â”‚  - Rice: 100 >= 2 âœ“                 â”‚          â”‚      â”‚
â”‚  - Salt: 200 >= 5 âœ“                 â”‚          â”‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚      â”‚
                   â”‚                              â”‚      â”‚
                   â–¼                              â”‚      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚      â”‚
â”‚  STEP 3: CALCULATE TOTALS            â”‚          â”‚      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚          â”‚      â”‚
â”‚  subtotal = 240 + 100 = 340          â”‚          â”‚      â”‚
â”‚  tax = 12 + 5 = 17                   â”‚          â”‚      â”‚
â”‚  discount = 10                       â”‚          â”‚      â”‚
â”‚  total = 340 + 17 - 10 = 347         â”‚          â”‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚      â”‚
                   â”‚                              â”‚      â”‚
                   â–¼                              â”‚      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚      â”‚
â”‚  STEP 4: GENERATE INVOICE NUMBER     â”‚          â”‚      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚          â”‚      â”‚
â”‚  INV-20260117-0001                   â”‚          â”‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚      â”‚
                   â”‚                              â”‚      â”‚
                   â–¼                              â”‚      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚      â”‚
â”‚  STEP 5: CREATE INVOICE              â”‚          â”‚      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚          â”‚      â”‚
â”‚  const invoice = await tx.invoice    â”‚          â”‚      â”‚
â”‚    .create({                         â”‚          â”‚      â”‚
â”‚      data: {                         â”‚          â”‚      â”‚
â”‚        invoiceNumber,                â”‚          â”‚      â”‚
â”‚        customerId: 1,                â”‚          â”‚      â”‚
â”‚        totalAmount: 347,             â”‚          â”‚      â”‚
â”‚        ...                           â”‚          â”‚      â”‚
â”‚      }                               â”‚          â”‚      â”‚
â”‚    });                               â”‚          â”‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚      â”‚
                   â”‚                              â”‚      â”‚
                   â–¼                              â”‚      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚      â”‚
â”‚  STEP 6: CREATE INVOICE ITEMS        â”‚          â”‚      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚          â”‚      â”‚
â”‚  await tx.invoiceItem.createMany({   â”‚          â”‚      â”‚
â”‚    data: [                           â”‚          â”‚      â”‚
â”‚      { invoiceId, productId: 1, ... }â”‚          â”‚      â”‚
â”‚      { invoiceId, productId: 2, ... }â”‚          â”‚      â”‚
â”‚    ]                                 â”‚          â”‚      â”‚
â”‚  });                                 â”‚          â”‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚      â”‚
                   â”‚                              â”‚      â”‚
                   â–¼                              â”‚      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚      â”‚
â”‚  STEP 7: DECREMENT STOCK             â”‚          â”‚      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚          â”‚      â”‚
â”‚  await tx.product.update({           â”‚          â”‚      â”‚
â”‚    where: { id: 1 },                 â”‚          â”‚      â”‚
â”‚    data: {                           â”‚          â”‚      â”‚
â”‚      stockQuantity: { decrement: 2 } â”‚          â”‚      â”‚
â”‚    }                                 â”‚          â”‚      â”‚
â”‚  });                                 â”‚          â”‚      â”‚
â”‚                                      â”‚          â”‚      â”‚
â”‚  Rice: 100 â†’ 98                      â”‚          â”‚      â”‚
â”‚  Salt: 200 â†’ 195                     â”‚          â”‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚      â”‚
                   â”‚                              â”‚      â”‚
                   â–¼                              â”‚      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚      â”‚
â”‚  STEP 8: CREATE INVENTORY LOGS       â”‚          â”‚      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚          â”‚      â”‚
â”‚  await tx.inventoryLog.create({      â”‚          â”‚      â”‚
â”‚    data: {                           â”‚          â”‚      â”‚
â”‚      productId: 1,                   â”‚          â”‚      â”‚
â”‚      transactionType: 'SALE',        â”‚          â”‚      â”‚
â”‚      quantityChange: -2,             â”‚          â”‚      â”‚
â”‚      previousStock: 100,             â”‚          â”‚      â”‚
â”‚      newStock: 98,                   â”‚          â”‚      â”‚
â”‚      referenceId: invoiceId,         â”‚          â”‚      â”‚
â”‚      notes: "Sale via INV-..."       â”‚          â”‚      â”‚
â”‚    }                                 â”‚          â”‚      â”‚
â”‚  });                                 â”‚          â”‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚      â”‚
                   â”‚                              â”‚      â”‚
                   â–¼                              â”‚      â”‚
        â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—              â”‚      â”‚
        â•‘   TRANSACTION COMMIT     â•‘              â”‚      â”‚
        â•‘   All changes saved!     â•‘              â”‚      â”‚
        â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•              â”‚      â”‚
                   â”‚                              â”‚      â”‚
                   â”‚           ERROR OCCURS? â—„â”€â”€â”€â”€â”˜      â”‚
                   â”‚           (Insufficient stock)      â”‚
                   â”‚                  â”‚                  â”‚
                   â”‚                  â–¼                  â”‚
                   â”‚         â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—       â”‚
                   â”‚         â•‘ TRANSACTION       â•‘       â”‚
                   â”‚         â•‘ ROLLBACK          â•‘       â”‚
                   â”‚         â•‘ No changes saved! â•‘       â”‚
                   â”‚         â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•       â”‚
                   â”‚                  â”‚                  â”‚
                   â–¼                  â”‚                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”
â”‚                SUCCESS RESPONSE      â”‚  ERROR RESPONSE  â”‚     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤
â”‚  {                                   â”‚  {               â”‚     â”‚
â”‚    "success": true,                  â”‚    "success": false,   â”‚
â”‚    "message": "Invoice created",     â”‚    "message": "Insuff â”‚
â”‚    "data": {                         â”‚      icient stock...", â”‚
â”‚      "invoiceNumber": "INV-...",     â”‚  }               â”‚     â”‚
â”‚      "totalAmount": "347.00",        â”‚                  â”‚     â”‚
â”‚      "customer": {...},              â”‚                  â”‚     â”‚
â”‚      "items": [...]                  â”‚                  â”‚     â”‚
â”‚    }                                 â”‚                  â”‚     â”‚
â”‚  }                                   â”‚                  â”‚     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜
                   â”‚                              â”‚
                   â–¼                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DATABASE STATE                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  SUCCESS:                        â”‚  ERROR:                      â”‚
â”‚  âœ… Invoice created              â”‚  âŒ No invoice created        â”‚
â”‚  âœ… Items created                â”‚  âŒ No items created          â”‚
â”‚  âœ… Stock decremented            â”‚  âŒ Stock unchanged           â”‚
â”‚  âœ… Logs created                 â”‚  âŒ No logs created           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Key Points

### 1. Transaction Boundary
```typescript
await prisma.$transaction(async (tx) => {
  // Everything inside is atomic
  // Either all succeed or all fail
});
```

### 2. Stock Validation BEFORE Writes
```typescript
// âœ… CORRECT: Validate first
if (stock < quantity) {
  throw AppError(...);  // Rollback happens automatically
}
// Then do writes...

// âŒ WRONG: Write first, validate later
// Could cause inconsistent data
```

### 3. Atomic Stock Decrement
```typescript
// âœ… CORRECT: Database-level decrement
stockQuantity: { decrement: quantity }

// âŒ WRONG: Read-then-write (race condition)
const product = await findProduct();
await updateProduct(product.stock - quantity);
```

### 4. Complete Audit Trail
```typescript
await tx.inventoryLog.create({
  transactionType: 'SALE',
  quantityChange: -quantity,  // Negative for sale
  previousStock,
  newStock,
  referenceId: invoiceId,
});
```

---

## ğŸ” Concurrent Request Handling

### Scenario: Two customers buying same product simultaneously

```
Time    Request A              Request B              Database
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T1      Start transaction      -                      Stock: 10
T2      Read stock: 10         Start transaction      Stock: 10
T3      Validate: 10 >= 8 âœ“   Read stock: 10         Stock: 10
T4      Create invoice         Validate: 10 >= 5 âœ“   Stock: 10
T5      Decrement stock        Create invoice         Stock: 10
T6      Stock: 10 - 8 = 2     Decrement stock        Stock: 2
T7      Commit                 Stock: 2 - 5 = -3 âŒ  Stock: 2
T8      âœ… Success             Rollback               Stock: 2
T9      -                      âŒ Error: Insufficient  Stock: 2

Result: Request A succeeds, Request B fails with error
Database: Consistent (Stock = 2)
```

**Prisma handles this automatically with proper transaction isolation!**

---

## ğŸ“Š Database Operations Count

For a typical invoice with 3 items:

| Operation | Count | Type |
|-----------|-------|------|
| SELECT | 1 | Fetch products |
| INSERT | 1 | Create invoice |
| INSERT | 3 | Create invoice items |
| UPDATE | 3 | Decrement stock |
| INSERT | 3 | Create inventory logs |
| **Total** | **11** | **1 transaction** |

**All 11 operations execute as one atomic unit!**

---

## ğŸ“ Error Scenarios Visualized

### Scenario A: Insufficient Stock
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Validate     â”‚
â”‚ Stock: 5     â”‚
â”‚ Need: 10     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Throw Error  â”‚ â”€â”€â”€â–º Transaction Rollback
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Database:    â”‚
â”‚ UNCHANGED    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Scenario B: Database Error
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Create       â”‚
â”‚ Invoice âœ“    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Create Items â”‚
â”‚ âœ“ âœ“ âœ—        â”‚ â”€â”€â”€â–º Database Error
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Rollback     â”‚ â”€â”€â”€â–º Undo Invoice Creation
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Database:    â”‚
â”‚ UNCHANGED    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ¨ Why This Matters

### Without Transactions:
```
Invoice Created âœ“
Items Created âœ“
Stock Update Failed âœ—

Result: Invoice exists but stock not deducted = DATA CORRUPTION
```

### With Transactions:
```
Invoice Created âœ“
Items Created âœ“
Stock Update Failed âœ—
â†’ ROLLBACK ALL

Result: Nothing changed = DATA INTEGRITY MAINTAINED
```

---

## ğŸ† Best Practices Implemented

1. âœ… **Validate Early**: Check stock before any writes
2. âœ… **Atomic Operations**: Use database-level decrement
3. âœ… **Bulk Inserts**: Use `createMany` for performance
4. âœ… **Audit Trail**: Log every stock change
5. âœ… **Error Messages**: Clear, actionable error messages
6. âœ… **Rollback Safety**: Automatic rollback on any error
7. âœ… **Isolation**: Proper transaction isolation level
8. âœ… **Historical Data**: Snapshot product details in invoice items

---

This visual representation shows exactly how the transaction logic ensures data integrity for your billing system.
